<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin | Mara</title>
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; }
      .error { background: #ffe6e6; border-left-color: #cc0000; }
      .success { background: #e6ffe6; border-left-color: #00cc00; }
    </style>
  </head>
  <body>
    <h1>Admin Panel - Mara</h1>
    <div id="status" class="debug">Initializing Decap CMS...</div>
    <div id="errors" class="debug error" style="display:none;"></div>

    <!-- Decap CMS root element -->
    <div id="nc-root"></div>

    <!-- Bloque de comprobaciones (SOLO logs, sin CMS.init aquÃ­) -->
    <script>
      console.log('Decap CMS script loaded');

      // Check if config exists
      fetch('./config.yml')
        .then(response => {
          if (response.ok) {
            document.getElementById('status').innerHTML += '<br>âœ“ Config file found';
            console.log('Config file accessible');
          } else {
            throw new Error('Config file not found');
          }
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>âœ— Config file error: ' + error.message;
          document.getElementById('errors').style.display = 'block';
          document.getElementById('errors').innerHTML = 'Error loading config.yml: ' + error.message;
          console.error('Config error:', error);
        });

      // Check if data file exists
      fetch('../data/products.json')
        .then(response => {
          if (response.ok) {
            document.getElementById('status').innerHTML += '<br>âœ“ Products data file found';
            console.log('Products data accessible');
          } else {
            throw new Error('Products data file not found');
          }
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>âœ— Products data error: ' + error.message;
          document.getElementById('errors').style.display = 'block';
          document.getElementById('errors').innerHTML += '<br>Error loading products.json: ' + error.message;
          console.error('Products data error:', error);
        });

      // Check uploads folder
      fetch('../assets/uploads/')
        .then(response => {
          document.getElementById('status').innerHTML += '<br>âœ“ Uploads folder accessible';
          console.log('Uploads folder accessible');
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>âš  Uploads folder may not exist or be accessible';
          console.warn('Uploads folder issue:', error);
        });

      // No inicializamos el CMS aquÃ­ para evitar doble init
      window.addEventListener('load', function() {
        console.log('Window loaded, CMS checks running...');
        if (typeof window.CMS === 'undefined') {
          document.getElementById('status').innerHTML += '<br>âœ— Decap CMS not loaded';
          const errBox = document.getElementById('errors');
          errBox.style.display = 'block';
          errBox.innerHTML += '<br>Decap CMS script failed to load';
          return;
        }
        document.getElementById('status').innerHTML += '<br>âœ“ Decap CMS script present';
      });

      // Global error handler
      window.addEventListener('error', function(e) {
        const errBox = document.getElementById('errors');
        errBox.style.display = 'block';
        errBox.innerHTML += '<br>Global error: ' + e.message;
        console.error('Global error:', e);
      });

      // Unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(e) {
        const errBox = document.getElementById('errors');
        errBox.style.display = 'block';
        errBox.innerHTML += '<br>Unhandled promise rejection: ' + e.reason;
        console.error('Unhandled rejection:', e);
      });
    </script>


    <!-- ðŸ”„ Carga Decap CMS con fallback y una sola inicializaciÃ³n -->
<script>
  window.CMS_MANUAL_INIT = true;

  (function () {
    const statusBox = document.getElementById('status');
    const errBox = document.getElementById('errors');

    function markError(msg) {
      errBox.style.display = 'block';
      errBox.innerHTML += '<br>' + msg;
      console.error(msg);
    }

    function initIfReady() {
      if (window.CMS) {
        try {
          CMS.init({ config: { load_config_file: true } });
          statusBox.innerHTML += '<br>âœ“ CMS initialized successfully';
        } catch (e) {
          markError('CMS init error: ' + e.message);
        }
      } else {
        markError('CMS global missing after load');
      }
    }

    function loadScript(src, onload, onerror) {
      const s = document.createElement('script');
      s.src = src;
      s.onload = onload;
      s.onerror = onerror;
      document.head.appendChild(s);
    }

    // 1) intenta UNPKG
    loadScript(
      'https://unpkg.com/decap-cms@3.9.1/dist/decap-cms.js',
      function () {
        statusBox.innerHTML += '<br>âœ“ Decap CMS loaded from unpkg';
        initIfReady();
      },
      function () {
        console.warn('Failed to load from unpkg, trying jsDelivrâ€¦');
        // 2) fallback a jsDelivr
        loadScript(
          'https://cdn.jsdelivr.net/npm/decap-cms@3.9.1/dist/decap-cms.js',
          function () {
            statusBox.innerHTML += '<br>âœ“ Decap CMS loaded from jsDelivr';
            initIfReady();
          },
          function () {
            markError('Could not load Decap CMS from CDNs');
          }
        );
      }
    );
  })();
</script>

  </body>
</html>
