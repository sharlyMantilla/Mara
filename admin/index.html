<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin | Mara</title>
    <meta name="robots" content="noindex" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; }
      .error { background: #ffe6e6; border-left-color: #cc0000; }
      .success { background: #e6ffe6; border-left-color: #00cc00; }
    </style>
  </head>
  <body>
    <h1>Admin Panel - Mara</h1>
    <div id="status" class="debug">Initializing Decap CMS...</div>
    <div id="errors" class="debug error" style="display:none;"></div>

    <!-- Decap CMS root element -->
    <div id="nc-root"></div>

    <!-- Bloque de comprobaciones (SOLO logs, sin CMS.init aquÃ­) -->
    <script>
      console.log('Decap CMS script loaded');

      // Check if config exists
      fetch('./config.yml')
        .then(response => {
          if (response.ok) {
            document.getElementById('status').innerHTML += '<br>&#10003; Config file found';
            console.log('Config file accessible');
          } else {
            throw new Error('Config file not found');
          }
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>&#10007; Config file error: ' + error.message;
          document.getElementById('errors').style.display = 'block';
          document.getElementById('errors').innerHTML = 'Error loading config.yml: ' + error.message;
          console.error('Config error:', error);
        });

      // Check if data file exists
      fetch('../data/products.json')
        .then(response => {
          if (response.ok) {
            document.getElementById('status').innerHTML += '<br>&#10003; Products data file found';
            console.log('Products data accessible');
          } else {
            throw new Error('Products data file not found');
          }
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>&#10007; Products data error: ' + error.message;
          document.getElementById('errors').style.display = 'block';
          document.getElementById('errors').innerHTML += '<br>Error loading products.json: ' + error.message;
          document.getElementById('status').innerHTML += '<br>&#10007; Products data error: ' + error.message;
        });

      // Check uploads folder
      fetch('../assets/uploads/')
        .then(response => {
          document.getElementById('status').innerHTML += '<br>&#10003; Uploads folder accessible';
          document.getElementById('status').innerHTML += '<br>&#10003; Uploads folder accessible';
        })
        .catch(error => {
          document.getElementById('status').innerHTML += '<br>&#9888; Uploads folder may not exist or be accessible';
          console.warn('Uploads folder issue:', error);
        });

      // No inicializamos el CMS aquÃ­ para evitar doble init
      window.addEventListener('load', function() {
        console.log('Window loaded, CMS checks running...');
        if (typeof window.CMS === 'undefined') {
          document.getElementById('status').innerHTML += '<br>&#10007; Decap CMS not loaded';
          const errBox = document.getElementById('errors');
          errBox.style.display = 'block';
          errBox.innerHTML += '<br>Decap CMS script failed to load';
          return;
        }
        document.getElementById('status').innerHTML += '<br>&#10003; Decap CMS script present';
      });

      // Global error handler
      window.addEventListener('error', function(e) {
        const errBox = document.getElementById('errors');
        errBox.style.display = 'block';
        errBox.innerHTML += '<br>Global error: ' + e.message;
        console.error('Global error:', e);
      });

      // Unhandled promise rejection handler
      window.addEventListener('unhandledrejection', function(e) {
        const errBox = document.getElementById('errors');
        errBox.style.display = 'block';
        errBox.innerHTML += '<br>Unhandled promise rejection: ' + e.reason;
        console.error('Unhandled rejection:', e);
      });
    </script>
    <!-- Debug: listener de autenticación OAuth (GitHub/Decap) -->
    <script>
      (function () {
        const statusEl = document.getElementById('status');
        function log(line) {
          try { console.log('[admin-auth]', line); } catch(_){}
          if (statusEl) statusEl.innerHTML += '<br>' + line;
        }
        window.addEventListener('message', function (event) {
          try {
            log('postMessage from ' + event.origin);
            log('data: ' + JSON.stringify(event.data));
            const d = event.data || {};
            const token = d.token || d.access_token || (d.data && (d.data.token || d.data.access_token));
            if (token) {
              log('Token received. (len=' + String(token).length + ')');
              try { localStorage.setItem('decap_token_debug', token); } catch (e) {}
              try { fetch('https://api.github.com/user', { headers: { Authorization: 'token ' + token } }).then(r => r.json()).then(u => log('GitHub user: '+JSON.stringify({login:u.login,id:u.id}))).catch(err => log('GitHub user fetch error: '+err)); } catch(e) {}
            } else {
              log('No token found in message payload');
            }
          } catch (err) {
            console.error('message handler error', err);
          }
        });
      })();
    </script>

<!-- Carga local de Decap CMS (sin CDNs) -->
<script>window.CMS_MANUAL_INIT = true;</script>
<script src="https://unpkg.com/decap-cms@3.7.2/dist/decap-cms.js"></script>
<script>
  try {
    CMS.init({ config: { load_config_file: true } });
    document.getElementById('status').innerHTML += '<br>&#10003; CMS initialized successfully (CDN)';
  } catch (e) {
    const errBox = document.getElementById('errors');
    errBox.style.display = 'block';
    errBox.innerHTML += '<br>CMS init error: ' + e.message;
    console.error(e);
  }
</script>

  

  </body>
</html>